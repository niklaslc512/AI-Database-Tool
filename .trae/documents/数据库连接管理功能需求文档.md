# 🗄️ 数据库连接管理功能 - 产品需求文档

## 1. 产品概述

数据库连接管理功能是AI语义化数据库管理系统的核心基础模块，为开发者角色提供多种数据库类型的连接配置和管理能力。该功能支持PostgreSQL和MongoDB两种主流数据库，提供安全的连接配置存储、连接测试验证和连接状态监控功能。

本功能专为开发者角色设计，通过直观的Web界面进行数据库连接的创建、编辑、测试和删除操作，确保系统能够安全可靠地访问各种数据源。

## 2. 核心功能

### 2.1 用户角色

| 角色 | 访问权限 | 核心功能 |
|------|----------|----------|
| 开发者 (Developer) | 数据库连接管理权限 | 创建、查看、编辑、删除自己的数据库连接 |
| 管理员 (Admin) | 全局数据库连接管理权限 | 查看所有用户的数据库连接，执行管理操作 |

### 2.2 功能模块

本数据库连接管理功能包含以下核心页面：

1. **数据库连接列表页面**: 展示数据库连接列表，支持搜索筛选和批量操作
2. **数据库连接创建页面**: 创建新的数据库连接，配置连接参数
3. **数据库连接详情页面**: 查看数据库连接详细信息和状态监控
4. **数据库连接编辑页面**: 修改数据库连接配置和参数

### 2.3 页面详情

| 页面名称 | 模块名称 | 功能描述 |
|----------|----------|----------|
| 数据库连接列表页面 | 列表展示模块 | 展示数据库连接列表，包含名称、类型、状态、主机地址、创建时间、最后连接时间等信息 |
| 数据库连接列表页面 | 搜索筛选模块 | 支持按名称、数据库类型、连接状态进行搜索和筛选 |
| 数据库连接列表页面 | 批量操作模块 | 支持批量测试连接、启用、禁用、删除数据库连接操作 |
| 数据库连接创建页面 | 基本信息配置 | 设置数据库连接名称、描述信息 |
| 数据库连接创建页面 | 数据库类型选择 | 选择数据库类型（PostgreSQL、MongoDB），动态显示对应配置项 |
| 数据库连接创建页面 | 连接参数配置 | 配置DSN连接字符串，支持PostgreSQL和MongoDB格式 |
| 数据库连接创建页面 | 高级配置模块 | 设置连接池大小、超时时间等高级参数 |
| 数据库连接创建页面 | 连接测试模块 | 实时测试数据库连接有效性，验证配置正确性 |
| 数据库连接详情页面 | 基本信息展示 | 显示数据库连接的所有配置信息和当前状态 |
| 数据库连接详情页面 | 连接状态监控 | 展示连接状态、响应时间、连接池使用情况等监控信息 |
| 数据库连接详情页面 | 使用统计模块 | 显示连接使用次数、查询统计、性能指标等 |
| 数据库连接编辑页面 | 配置修改模块 | 修改数据库连接的各项配置参数 |
| 数据库连接编辑页面 | 状态管理模块 | 启用、禁用、重新测试数据库连接 |

## 3. 核心流程

### 开发者操作流程

开发者登录系统后，可以通过以下流程管理数据库连接：

1. **访问数据库连接管理页面** → 查看现有数据库连接列表
2. **创建新数据库连接** → 选择数据库类型 → 配置DSN连接字符串 → 测试连接 → 保存配置
3. **查看数据库连接详情** → 获取连接状态和使用统计
4. **编辑数据库连接配置** → 修改连接参数 → 重新测试连接
5. **管理数据库连接状态** → 启用、禁用或删除连接

### 管理员操作流程

管理员除了拥有开发者的所有权限外，还可以：

1. **查看全局数据库连接** → 监控所有用户的数据库连接状态
2. **执行系统维护** → 检查连接健康状况和性能问题
3. **批量管理操作** → 对多个数据库连接执行批量操作

```mermaid
graph TD
  A[开发者登录] --> B[数据库连接管理页面]
  B --> C[查看连接列表]
  B --> D[创建新连接]
  B --> E[编辑现有连接]
  B --> F[查看连接详情]
  
  D --> G[选择数据库类型]
  G --> H[配置基本信息]
  H --> I[设置DSN连接字符串]
  I --> J[配置高级选项]
  J --> K[测试连接]
  K --> L{连接成功?}
  L -->|是| M[保存配置]
  L -->|否| N[修改参数]
  N --> K
  
  E --> O[修改配置]
  O --> P[重新测试]
  P --> Q[保存更改]
  
  F --> R[查看状态监控]
  F --> S[查看使用统计]
```

## 4. 用户界面设计

### 4.1 设计风格

遵循系统UI设计标准，采用以下设计元素：

- **主色调**: 绿色系 (#10b981) 作为主要操作按钮和连接成功状态指示
- **辅助色**: 白色背景 (#ffffff)、深灰文本 (#1f2937)、浅灰边框 (#e2e8f0)
- **状态色**: 绿色(连接成功)、红色(连接失败)、橙色(连接中)、灰色(未连接)
- **按钮风格**: 圆角设计，带有边框和阴影效果，悬停时有过渡动画
- **字体**: 系统默认字体，标题使用粗体，正文使用常规字重
- **布局风格**: 卡片式布局，清晰的层次结构，响应式设计
- **图标风格**: 使用Lucide图标库，线性风格，数据库类型使用专用图标

### 4.2 页面设计概览

| 页面名称 | 模块名称 | UI元素 |
|----------|----------|--------|
| 数据库连接列表页面 | 页面头部 | 绿色渐变背景卡片，包含页面标题、描述和"创建数据库连接"按钮，使用绿色主色调 |
| 数据库连接列表页面 | 搜索筛选区域 | 白色卡片容器，包含搜索输入框、数据库类型筛选、状态筛选，绿色边框聚焦效果 |
| 数据库连接列表页面 | 连接卡片列表 | 网格布局的连接卡片，每个卡片显示数据库图标、名称、类型、状态指示器 |
| 数据库连接列表页面 | 状态指示器 | 圆形状态点，绿色(在线)、红色(离线)、橙色(连接中)、灰色(未知) |
| 数据库连接创建页面 | 类型选择卡片 | 大尺寸选择卡片，PostgreSQL和MongoDB图标，选中时绿色边框高亮 |
| 数据库连接创建页面 | 配置表单 | 分组的表单字段，基本配置、DSN连接字符串、高级设置三个折叠面板 |
| 数据库连接创建页面 | 连接测试区域 | 独立的测试卡片，包含测试按钮、结果显示、连接时间指示 |
| 数据库连接创建页面 | DSN预览 | 只读文本框显示生成的连接字符串，支持复制功能 |
| 数据库连接详情页面 | 信息概览卡片 | 网格布局显示连接基本信息，状态使用对应颜色的徽章显示 |
| 数据库连接详情页面 | 监控图表 | 响应时间趋势图、连接池使用率图表，使用绿色主题配色 |
| 数据库连接详情页面 | 操作按钮组 | 测试连接(绿色)、编辑(蓝色)、禁用(橙色)、删除(红色)按钮 |
| 数据库连接编辑页面 | 编辑表单 | 与创建页面相似的表单设计，预填充现有数据，保存按钮使用绿色主色调 |

### 4.3 响应式设计

- **桌面端优先**: 主要针对开发者的桌面工作环境设计
- **移动端适配**: 连接卡片在移动端堆叠显示，表单字段垂直排列
- **触摸优化**: 按钮和交互元素满足最小44px的触摸目标要求
- **横屏适配**: 支持平板设备的横屏显示模式

## 5. 数据模型设计

### 5.1 数据库连接数据结构

```typescript
// 数据库类型枚举
type DatabaseType = 'postgresql' | 'mongodb';

// 数据库连接接口
interface DatabaseConnection {
  id: string;                    // 🆔 连接唯一标识符
  name: string;                  // 📝 连接名称
  type: DatabaseType;            // 🗄️ 数据库类型
  dsn: string;                   // 🔗 数据源名称（连接字符串）
  userId: string;                // 👤 所属用户ID
  status: 'active' | 'inactive' | 'error'; // 📊 连接状态
  createdAt: Date;              // 📅 创建时间
  updatedAt: Date;              // 🔄 更新时间
  lastConnectedAt?: Date;       // ⏰ 最后连接时间
  description?: string;          // 📄 描述信息
}

// 创建数据库连接请求
interface CreateDatabaseConnectionRequest {
  name: string;
  description?: string;
  type: DatabaseType;
  dsn: string;                   // 数据源名称（连接字符串）
  connectionTimeout?: number;
  maxConnections?: number;
}

// 数据库连接测试结果
interface ConnectionTestResult {
  success: boolean;
  message: string;
  responseTime?: number;        // 响应时间（毫秒）
  serverVersion?: string;       // 服务器版本
  timestamp: Date;
}

// 数据库连接统计
interface DatabaseConnectionStats {
  totalConnections: number;
  successfulConnections: number;
  failedConnections: number;
  averageResponseTime: number;
  lastConnectionTime?: Date;
  uptime: number;               // 可用时间百分比
}

// PostgreSQL特定配置
interface PostgreSQLConfig {
  schema?: string;              // 默认模式
  applicationName?: string;     // 应用程序名称
  searchPath?: string[];        // 搜索路径
}

// MongoDB特定配置
interface MongoDBConfig {
  authSource?: string;          // 认证数据库
  replicaSet?: string;          // 副本集名称
  readPreference?: string;      // 读偏好
}
```

### 5.2 数据库表设计

```sql
-- 数据库连接表
CREATE TABLE database_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('postgresql', 'mongodb')),
  dsn TEXT NOT NULL, -- 数据源名称（连接字符串）
  user_id UUID NOT NULL REFERENCES users(id),
  status VARCHAR(20) DEFAULT 'inactive' CHECK (status IN ('active', 'inactive', 'error')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_connected_at TIMESTAMP WITH TIME ZONE,
  description TEXT
);

-- 索引
CREATE INDEX idx_database_connections_user_id ON database_connections(user_id);
CREATE INDEX idx_database_connections_type ON database_connections(type);
CREATE INDEX idx_database_connections_is_active ON database_connections(is_active);
CREATE INDEX idx_database_connections_last_connected ON database_connections(last_connected_at DESC);

-- 数据库连接测试日志表
CREATE TABLE connection_test_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  connection_id UUID NOT NULL REFERENCES database_connections(id) ON DELETE CASCADE,
  success BOOLEAN NOT NULL,
  message TEXT,
  response_time INTEGER, -- 毫秒
  server_version VARCHAR(50),
  error_code VARCHAR(20),
  tested_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 测试日志索引
CREATE INDEX idx_connection_test_logs_connection_id ON connection_test_logs(connection_id);
CREATE INDEX idx_connection_test_logs_created_at ON connection_test_logs(created_at DESC);
CREATE INDEX idx_connection_test_logs_success ON connection_test_logs(success);

-- 数据库连接使用统计表
CREATE TABLE connection_usage_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  connection_id UUID NOT NULL REFERENCES database_connections(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  connection_count INTEGER NOT NULL DEFAULT 0,
  query_count INTEGER NOT NULL DEFAULT 0,
  total_response_time INTEGER NOT NULL DEFAULT 0, -- 毫秒
  error_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- 确保每个连接每天只有一条记录
  UNIQUE(connection_id, date)
);

-- 使用统计索引
CREATE INDEX idx_connection_usage_stats_connection_id ON connection_usage_stats(connection_id);
CREATE INDEX idx_connection_usage_stats_date ON connection_usage_stats(date DESC);
```

## 6. API接口设计

### 6.1 RESTful API端点

```typescript
// 获取数据库连接列表
GET /api/v1/database-connections
Query Parameters:
- page: number (页码)
- limit: number (每页数量)
- search: string (搜索关键词)
- type: 'postgresql' | 'mongodb' (数据库类型筛选)
- status: 'active' | 'inactive' (状态筛选)

// 创建数据库连接
POST /api/v1/database-connections
Body: CreateDatabaseConnectionRequest

// 获取数据库连接详情
GET /api/v1/database-connections/:id

// 更新数据库连接
PUT /api/v1/database-connections/:id
Body: Partial<CreateDatabaseConnectionRequest>

// 删除数据库连接
DELETE /api/v1/database-connections/:id

// 启用/禁用数据库连接
PATCH /api/v1/database-connections/:id/status
Body: { isActive: boolean }

// 测试数据库连接
POST /api/v1/database-connections/:id/test

// 测试新的连接配置（创建前测试）
POST /api/v1/database-connections/test
Body: CreateDatabaseConnectionRequest

// 获取数据库连接统计
GET /api/v1/database-connections/:id/stats
Query Parameters:
- period: 'day' | 'week' | 'month' (统计周期)

// 获取数据库连接测试日志
GET /api/v1/database-connections/:id/test-logs
Query Parameters:
- page: number
- limit: number
- startDate: string (ISO日期)
- endDate: string (ISO日期)

// 获取数据库连接的表结构信息
GET /api/v1/database-connections/:id/schema

// 批量测试连接
POST /api/v1/database-connections/batch-test
Body: { connectionIds: string[] }
```

### 6.2 响应格式示例

```json
// 成功响应 - 数据库连接列表
{
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "生产环境PostgreSQL",
      "type": "postgresql",
      "dsn": "postgresql://app_user:password@prod-db.example.com:5432/main_db?sslmode=require",
      "userId": "user123",
      "status": "active",
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-15T10:30:00Z",
      "lastConnectedAt": "2024-01-15T10:30:00Z",
      "description": "主要业务数据库"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 15,
    "totalPages": 2
  }
}

// 成功响应 - 连接测试结果
{
  "success": true,
  "message": "连接成功",
  "responseTime": 45,
  "serverVersion": "PostgreSQL 14.5",
  "timestamp": "2024-01-15T10:30:00Z"
}

// 失败响应 - 连接测试失败
{
  "success": false,
  "message": "连接超时",
  "responseTime": 30000,
  "timestamp": "2024-01-15T10:30:00Z",
  "errorCode": "TIMEOUT"
}

// 成功响应 - 连接统计
{
  "totalConnections": 1250,
  "successfulConnections": 1200,
  "failedConnections": 50,
  "averageResponseTime": 85,
  "lastConnectionTime": "2024-01-15T10:30:00Z",
  "uptime": 96.0,
  "dailyStats": [
    {
      "date": "2024-01-15",
      "connections": 150,
      "queries": 2500,
      "averageResponseTime": 80,
      "errors": 2
    }
  ]
}

// 错误响应
{
  "message": "数据库连接名称已存在",
  "timestamp": "2024-01-15T10:30:00Z",
  "path": "/api/v1/database-connections"
}
```

## 7. 安全考虑

### 7.1 DSN安全
- 数据库DSN连接字符串使用AES-256加密存储
- 加密密钥通过环境变量管理，不存储在代码中
- 支持DSN轮换，提供连接字符串更新接口

### 7.2 连接安全
- DSN连接字符串支持SSL/TLS加密连接配置
- 连接超时设置防止长时间占用资源
- 连接池限制防止资源耗尽

### 7.3 权限控制
- 基于角色的访问控制（RBAC）
- 用户只能管理自己创建的数据库连接
- 管理员可以查看和管理所有连接

### 7.4 审计日志
- 记录所有数据库连接操作日志
- 记录连接测试结果和失败原因
- 支持连接异常告警

## 8. 技术实现要点

### 8.1 前端技术栈
- **框架**: Vue 3 + Composition API
- **样式**: TailwindCSS 4 + DaisyUI 5
- **状态管理**: Pinia
- **HTTP客户端**: Axios
- **图表**: ECharts (用于监控图表)
- **表单验证**: VeeValidate

### 8.2 后端技术栈
- **框架**: Express.js + TypeScript
- **数据库**: PostgreSQL
- **数据库驱动**: pg (PostgreSQL), mongodb (MongoDB)
- **加密**: crypto (Node.js内置)
- **连接池**: 各数据库对应的连接池实现

### 8.3 关键实现细节

#### 连接池管理
```typescript
// 连接池管理器
class ConnectionPoolManager {
  private pools: Map<string, any> = new Map()
  
  async getConnection(connectionId: string): Promise<any> {
    if (!this.pools.has(connectionId)) {
      const config = await this.getConnectionConfig(connectionId)
      const pool = this.createPool(config)
      this.pools.set(connectionId, pool)
    }
    return this.pools.get(connectionId)
  }
  
  async testConnection(config: DatabaseConnectionConfig): Promise<ConnectionTestResult> {
    const startTime = Date.now()
    try {
      const connection = await this.createTestConnection(config)
      const responseTime = Date.now() - startTime
      await connection.close()
      
      return {
        success: true,
        message: '连接成功',
        responseTime,
        timestamp: new Date()
      }
    } catch (error) {
      return {
        success: false,
        message: error.message,
        responseTime: Date.now() - startTime,
        timestamp: new Date()
      }
    }
  }
}
```

#### DSN连接字符串加密/解密
```typescript
// DSN加密服务
class DSNEncryptionService {
  private readonly algorithm = 'aes-256-gcm'
  private readonly key = process.env.DB_DSN_ENCRYPTION_KEY
  
  encrypt(dsn: string): string {
    const iv = crypto.randomBytes(16)
    const cipher = crypto.createCipher(this.algorithm, this.key)
    cipher.setAAD(Buffer.from('database-dsn'))
    
    let encrypted = cipher.update(dsn, 'utf8', 'hex')
    encrypted += cipher.final('hex')
    
    const authTag = cipher.getAuthTag()
    return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`
  }
  
  decrypt(encryptedDSN: string): string {
    const [ivHex, authTagHex, encrypted] = encryptedDSN.split(':')
    const iv = Buffer.from(ivHex, 'hex')
    const authTag = Buffer.from(authTagHex, 'hex')
    
    const decipher = crypto.createDecipher(this.algorithm, this.key)
    decipher.setAAD(Buffer.from('database-dsn'))
    decipher.setAuthTag(authTag)
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8')
    decrypted += decipher.final('utf8')
    
    return decrypted
  }
}
```

#### 数据库适配器模式
```typescript
// 数据库适配器接口
interface DatabaseAdapter {
  connect(config: DatabaseConnectionConfig): Promise<void>
  disconnect(): Promise<void>
  testConnection(): Promise<ConnectionTestResult>
  getSchema(): Promise<SchemaInfo>
  executeQuery(query: string): Promise<QueryResult>
}

// PostgreSQL适配器
class PostgreSQLAdapter implements DatabaseAdapter {
  private pool: Pool
  
  async connect(config: DatabaseConnectionConfig): Promise<void> {
    this.pool = new Pool({
      connectionString: config.dsn,
      max: config.maxConnections || 10,
      connectionTimeoutMillis: (config.connectionTimeout || 30) * 1000
    })
  }
  
  async testConnection(): Promise<ConnectionTestResult> {
    const startTime = Date.now()
    try {
      const client = await this.pool.connect()
      const result = await client.query('SELECT version()')
      client.release()
      
      return {
        success: true,
        message: '连接成功',
        responseTime: Date.now() - startTime,
        serverVersion: result.rows[0].version,
        timestamp: new Date()
      }
    } catch (error) {
      return {
        success: false,
        message: error.message,
        responseTime: Date.now() - startTime,
        timestamp: new Date()
      }
    }
  }
}

// MongoDB适配器
class MongoDBAdapter implements DatabaseAdapter {
  private client: MongoClient
  
  async connect(config: DatabaseConnectionConfig): Promise<void> {
    this.client = new MongoClient(config.dsn, {
      maxPoolSize: config.maxConnections || 10,
      serverSelectionTimeoutMS: (config.connectionTimeout || 30) * 1000
    })
    await this.client.connect()
  }
  
  async testConnection(): Promise<ConnectionTestResult> {
    const startTime = Date.now()
    try {
      await this.client.db().admin().ping()
      const serverStatus = await this.client.db().admin().serverStatus()
      
      return {
        success: true,
        message: '连接成功',
        responseTime: Date.now() - startTime,
        serverVersion: serverStatus.version,
        timestamp: new Date()
      }
    } catch (error) {
      return {
        success: false,
        message: error.message,
        responseTime: Date.now() - startTime,
        timestamp: new Date()
      }
    }
  }
}
```

## 9. 性能优化

### 9.1 连接池优化
- 合理设置连接池大小，避免资源浪费
- 实现连接池监控，及时发现性能瓶颈
- 支持连接池预热，减少首次连接延迟

### 9.2 缓存策略
- 缓存数据库连接配置，减少数据库查询
- 缓存连接测试结果，避免频繁测试
- 实现连接状态缓存，提高响应速度
