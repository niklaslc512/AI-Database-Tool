<template>
  <div class=" flex flex-col bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 overflow-hidden">
    <!-- ğŸ“Š é¡µé¢å¤´éƒ¨ -->
    <div class="bg-white/80 backdrop-blur-sm border-b border-gray-200 flex-shrink-0 px-6 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
            æ•°æ®åº“è¿æ¥ç®¡ç†
          </h1>
          <p class="mt-2 text-gray-600">
            ç®¡ç†å’Œé…ç½®æ•°æ®åº“è¿æ¥
          </p>
        </div>
        <button 
          @click="showCreateModal = true" 
          class="btn bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white border-0 shadow-lg hover:shadow-xl transition-all duration-300"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          æ·»åŠ è¿æ¥
        </button>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
    <div class="bg-white/70 backdrop-blur-sm border-b border-gray-200 px-6 py-4 shadow-sm flex-shrink-0">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-lg hover:shadow-xl transition-all duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">æ€»è¿æ¥æ•°</p>
              <p class="text-2xl font-bold text-gray-900">{{ connections.length }}</p>
            </div>
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-lg hover:shadow-xl transition-all duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">åœ¨çº¿è¿æ¥</p>
              <p class="text-2xl font-bold text-green-600">{{ onlineConnectionsCount }}</p>
            </div>
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-lg hover:shadow-xl transition-all duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">ç¦»çº¿è¿æ¥</p>
              <p class="text-2xl font-bold text-red-600">{{ offlineConnectionsCount }}</p>
            </div>
            <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-lg hover:shadow-xl transition-all duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">æœªæµ‹è¯•</p>
              <p class="text-2xl font-bold text-yellow-600">{{ untestedConnectionsCount }}</p>
            </div>
            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex flex-col overflow-hidden min-h-0">
      <div class="bg-white/70 backdrop-blur-sm flex flex-col shadow-lg overflow-hidden min-h-0 rounded-xl border border-white/20">
        <!-- è¡¨å¤´ -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
          <h2 class="text-xl font-semibold text-gray-900">
            æ•°æ®åº“è¿æ¥
          </h2>
          <div class="flex items-center gap-4">
            <!-- æœç´¢æ¡† -->
            <div class="relative">
              <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input 
                v-model="searchQuery" 
                type="text" 
                placeholder="æœç´¢è¿æ¥..." 
                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
              />
            </div>
            <!-- ç­›é€‰å™¨ -->
            <select 
              v-model="typeFilter" 
              class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
            >
              <option value="">æ‰€æœ‰ç±»å‹</option>
              <option value="postgresql">PostgreSQL</option>
              <option value="mongodb">MongoDB</option>
            </select>
          </div>
        </div>

        <!-- è¡¨æ ¼å†…å®¹ -->
        <div class="flex-1 overflow-y-auto min-h-0 p-6">
          <div v-if="loading" class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
          </div>

          <div v-else-if="filteredConnections.length === 0" class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— æ•°æ®åº“è¿æ¥</h3>
            <p class="text-gray-600 mb-6">å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ•°æ®åº“è¿æ¥</p>
            <button 
              @click="showCreateModal = true" 
              class="btn bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white border-0"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              æ·»åŠ è¿æ¥
            </button>
          </div>

          <div v-else class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 sticky top-0">
                <tr class="text-gray-700">
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¿æ¥ä¿¡æ¯</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ•°æ®åº“ç±»å‹</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¿æ¥çŠ¶æ€</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€åæµ‹è¯•</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ›å»ºæ—¶é—´</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                </tr>
              </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="connection in filteredConnections" :key="connection.id" class="hover:bg-gray-50 transition-colors duration-200">
                  <!-- è¿æ¥ä¿¡æ¯ -->
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col">
                      <div class="text-sm font-medium text-gray-900">{{ connection.name }}</div>
                      <div class="text-sm text-gray-500 mt-1">
                        {{ maskDsn(connection.dsn) }}
                      </div>
                    </div>
                  </td>

                  <!-- æ•°æ®åº“ç±»å‹ -->
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                      <div class="w-8 h-8 rounded-lg flex items-center justify-center" :class="getTypeIconClass(connection.type)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                        </svg>
                      </div>
                      <span class="text-sm font-medium text-gray-900">{{ getTypeLabel(connection.type) }}</span>
                    </div>
                  </td>

                <!-- è¿æ¥çŠ¶æ€ -->
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <div class="inline-flex px-2 py-1 text-xs font-semibold rounded-full" :class="getStatusBadgeClass(connection.status)">
                      {{ getStatusText(connection.status) }}
                    </div>
                    <div v-if="connection.testResult" class="tooltip" :data-tip="connection.testResult">
                      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                  </div>
                </td>

                <!-- æœ€åæµ‹è¯• -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div v-if="connection.lastTestedAt">
                    {{ formatRelativeTime(connection.lastTestedAt) }}
                  </div>
                  <div v-else class="text-gray-400">
                    ä»æœªæµ‹è¯•
                  </div>
                </td>

                <!-- åˆ›å»ºæ—¶é—´ -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div>{{ formatDate(connection.createdAt) }}</div>
                  <div class="text-gray-400">{{ formatTime(connection.createdAt) }}</div>
                </td>

                  <!-- æ“ä½œ -->
                  <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                    <div class="flex items-center justify-center space-x-2">
                      <button 
                        @click="editConnection(connection)" 
                        class="text-blue-600 hover:text-blue-900 transition-colors duration-200"
                        title="ç¼–è¾‘"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      <button 
                        @click="deleteConnection(connection)" 
                        class="text-red-600 hover:text-red-900 transition-colors duration-200"
                        title="åˆ é™¤"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </td>
                 </tr>
               </tbody>
             </table>
           </div>
         </div>
       </div>
     </div>

    <!-- åˆ›å»º/ç¼–è¾‘æ•°æ®åº“è¿æ¥æ¨¡æ€æ¡† -->
    <div v-if="showCreateModal" class="modal modal-open">
      <div class="modal-box max-w-2xl bg-white">
        <h3 class="font-bold text-lg mb-4 text-gray-900">
          {{ editingConnection ? 'ç¼–è¾‘æ•°æ®åº“è¿æ¥' : 'åˆ›å»ºæ•°æ®åº“è¿æ¥' }}
        </h3>
        
        <form @submit.prevent="submitConnection" class="space-y-4">
          <!-- è¿æ¥åç§° -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-gray-700">è¿æ¥åç§° *</span>
            </label>
            <input 
              v-model="formData.name" 
              type="text" 
              placeholder="è¯·è¾“å…¥è¿æ¥åç§°" 
              class="input input-bordered w-full border-gray-300 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all duration-200"
              required
            />
          </div>

          <!-- æ•°æ®åº“ç±»å‹ -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-gray-700">æ•°æ®åº“ç±»å‹ *</span>
            </label>
            <div class="grid grid-cols-2 gap-3">
              <label class="label cursor-pointer justify-start gap-3 p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" :class="{ 'border-green-500 bg-green-50': formData.type === 'postgresql' }">
                <input 
                  v-model="formData.type" 
                  value="postgresql" 
                  type="radio" 
                  class="radio radio-success"
                  required
                />
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                    </svg>
                  </div>
                  <div>
                    <div class="label-text font-medium text-gray-900">PostgreSQL</div>
                    <div class="text-xs text-gray-600">å…³ç³»å‹æ•°æ®åº“</div>
                  </div>
                </div>
              </label>
              <label class="label cursor-pointer justify-start gap-3 p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" :class="{ 'border-green-500 bg-green-50': formData.type === 'mongodb' }">
                <input 
                  v-model="formData.type" 
                  value="mongodb" 
                  type="radio" 
                  class="radio radio-success"
                  required
                />
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                    </svg>
                  </div>
                  <div>
                    <div class="label-text font-medium text-gray-900">MongoDB</div>
                    <div class="text-xs text-gray-600">æ–‡æ¡£å‹æ•°æ®åº“</div>
                  </div>
                </div>
              </label>
            </div>
          </div>

          <!-- DSNè¿æ¥å­—ç¬¦ä¸² -->
          <div class="form-control">
            <div class="flex flex-col gap-2">
              <div class="flex items-center justify-between">
                <span class="label-text font-medium">DSNè¿æ¥å­—ç¬¦ä¸² *</span>
                <span class="label-text-alt text-info cursor-pointer hover:text-info-focus transition-colors" @click="showDsnHelp = !showDsnHelp">
                  <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  æ ¼å¼è¯´æ˜
                </span>
              </div>
              <textarea 
                v-model="formData.dsn" 
                placeholder="è¯·è¾“å…¥DSNè¿æ¥å­—ç¬¦ä¸²" 
                class="textarea textarea-bordered h-24 font-mono text-sm w-full"
                required
              ></textarea>
            </div>
            
            <!-- DSNæ ¼å¼è¯´æ˜ -->
            <div v-if="showDsnHelp" class="mt-3 p-4 bg-base-200 rounded-lg border border-base-300">
              <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h4 class="font-medium text-base-content">DSNæ ¼å¼è¯´æ˜</h4>
              </div>
              <div class="space-y-3">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">P</div>
                    <strong class="text-base-content">PostgreSQL:</strong>
                  </div>
                  <code class="block p-3 bg-base-100 rounded border text-sm font-mono">
                    postgresql://username:password@host:port/database?sslmode=require
                  </code>
                  <div class="text-xs text-base-content/70 mt-1">ç¤ºä¾‹: postgresql://user:pass@localhost:5432/mydb</div>
                </div>
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 rounded bg-green-100 text-green-600 flex items-center justify-center text-xs font-bold">M</div>
                    <strong class="text-base-content">MongoDB:</strong>
                  </div>
                  <code class="block p-3 bg-base-100 rounded border text-sm font-mono">
                    mongodb://username:password@host:port/database?authSource=admin
                  </code>
                  <div class="text-xs text-base-content/70 mt-1">ç¤ºä¾‹: mongodb://user:pass@localhost:27017/mydb</div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-action flex justify-end">
            <div class="flex gap-2">
              <button type="button" @click="closeCreateModal" class="btn btn-ghost">å–æ¶ˆ</button>
              <button 
                type="submit" 
                class="btn bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white border-0"
                :disabled="submitting"
              >
                <span v-if="submitting" class="loading loading-spinner loading-sm"></span>
                {{ submitting ? 'ä¿å­˜ä¸­...' : (editingConnection ? 'æ›´æ–°è¿æ¥' : 'åˆ›å»ºè¿æ¥') }}
              </button>
            </div>
          </div>
        </form>
       </div>
     </div>
   </div>
 </template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import type { DatabaseConnection } from '@/types'
import { useToast } from '@/composables/useToast'
import { connectionApi } from '@/utils/api'

// å“åº”å¼æ•°æ®
const loading = ref(false)
const submitting = ref(false)
const showCreateModal = ref(false)
const showDsnHelp = ref(false)
const editingConnection = ref<DatabaseConnection | null>(null)
const searchQuery = ref('')
const typeFilter = ref('')
const statusFilter = ref('')

// æ•°æ®åº“è¿æ¥åˆ—è¡¨
const connections = ref<DatabaseConnection[]>([])

// è¡¨å•æ•°æ®
const formData = ref({
  name: '',
  type: '',
  dsn: ''
})

// Toast é€šçŸ¥
const { showToast } = useToast()

// è®¡ç®—å±æ€§
const onlineConnectionsCount = computed(() => 
  connections.value.filter(conn => conn.status === 'connected').length
)

const offlineConnectionsCount = computed(() => 
  connections.value.filter(conn => conn.status === 'disconnected').length
)

const untestedConnectionsCount = computed(() => 
  connections.value.filter(conn => conn.status === 'untested').length
)

const filteredConnections = computed(() => {
  let filtered = connections.value

  // æœç´¢è¿‡æ»¤
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    filtered = filtered.filter(conn => 
      conn.name.toLowerCase().includes(query) ||
      conn.dsn.toLowerCase().includes(query)
    )
  }

  // ç±»å‹è¿‡æ»¤
  if (typeFilter.value) {
    filtered = filtered.filter(conn => conn.type === typeFilter.value)
  }

  // çŠ¶æ€è¿‡æ»¤
  if (statusFilter.value) {
    filtered = filtered.filter(conn => conn.status === statusFilter.value)
  }

  return filtered
})

// å·¥å…·å‡½æ•°
const maskDsn = (dsn: string) => {
  // éšè—DSNä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼ˆç”¨æˆ·åå’Œå¯†ç ï¼‰
  return dsn.replace(/:([^:@]+)@/, ':***@')
}

const getTypeLabel = (type: string) => {
  const typeMap: Record<string, string> = {
    postgresql: 'PostgreSQL',
    mongodb: 'MongoDB'
  }
  return typeMap[type] || type
}

const getTypeIconClass = (type: string) => {
  const classMap: Record<string, string> = {
    postgresql: 'bg-blue-100 text-blue-600',
    mongodb: 'bg-green-100 text-green-600'
  }
  return classMap[type] || 'bg-gray-100 text-gray-600'
}

const getStatusText = (status: string) => {
  const statusMap: Record<string, string> = {
    connected: 'åœ¨çº¿',
    disconnected: 'ç¦»çº¿',
    untested: 'æœªæµ‹è¯•'
  }
  return statusMap[status] || status
}

const getStatusBadgeClass = (status: string) => {
  const classMap: Record<string, string> = {
    connected: 'badge-success',
    disconnected: 'badge-error',
    untested: 'badge-warning'
  }
  return classMap[status] || 'badge-ghost'
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('zh-CN')
}

const formatTime = (dateString: string) => {
  return new Date(dateString).toLocaleTimeString('zh-CN')
}

const formatRelativeTime = (dateString: string) => {
  const now = new Date()
  const date = new Date(dateString)
  const diffMs = now.getTime() - date.getTime()
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))
  
  if (diffDays === 0) return 'ä»Šå¤©'
  if (diffDays === 1) return 'æ˜¨å¤©'
  if (diffDays < 7) return `${diffDays}å¤©å‰`
  if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`
  return `${Math.floor(diffDays / 30)}æœˆå‰`
}

// APIæ“ä½œ
const loadConnections = async () => {
  loading.value = true
  try {
    connections.value = await connectionApi.getConnections()
  } catch (error) {
    showToast('åŠ è½½æ•°æ®åº“è¿æ¥å¤±è´¥', 'error')
    console.error('åŠ è½½æ•°æ®åº“è¿æ¥å¤±è´¥:', error)
  } finally {
    loading.value = false
  }
}

const submitConnection = async () => {
  submitting.value = true
  try {
    if (editingConnection.value) {
      // æ›´æ–°æ•°æ®åº“è¿æ¥
      await connectionApi.updateConnection(editingConnection.value.id, formData.value)
      showToast('æ•°æ®åº“è¿æ¥æ›´æ–°æˆåŠŸ', 'success')
    } else {
      // åˆ›å»ºæ•°æ®åº“è¿æ¥
      await connectionApi.createConnection(formData.value)
      showToast('æ•°æ®åº“è¿æ¥åˆ›å»ºæˆåŠŸ', 'success')
    }
    closeCreateModal()
    await loadConnections()
  } catch (error) {
    showToast(editingConnection.value ? 'æ•°æ®åº“è¿æ¥æ›´æ–°å¤±è´¥' : 'æ•°æ®åº“è¿æ¥åˆ›å»ºå¤±è´¥', 'error')
    console.error('æ•°æ®åº“è¿æ¥æ“ä½œå¤±è´¥:', error)
  } finally {
    submitting.value = false
  }
}

const editConnection = (connection: DatabaseConnection) => {
  editingConnection.value = connection
  formData.value = {
    name: connection.name,
    type: connection.type,
    dsn: connection.dsn
  }
  showCreateModal.value = true
}



const deleteConnection = async (connection: DatabaseConnection) => {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤æ•°æ®åº“è¿æ¥ "${connection.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
    return
  }

  try {
    await connectionApi.deleteConnection(connection.id)
    showToast('æ•°æ®åº“è¿æ¥åˆ é™¤æˆåŠŸ', 'success')
    await loadConnections()
  } catch (error) {
    showToast('æ•°æ®åº“è¿æ¥åˆ é™¤å¤±è´¥', 'error')
    console.error('åˆ é™¤æ•°æ®åº“è¿æ¥å¤±è´¥:', error)
  }
}

const closeCreateModal = () => {
  showCreateModal.value = false
  showDsnHelp.value = false
  editingConnection.value = null
  formData.value = {
    name: '',
    type: '',
    dsn: ''
  }
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  loadConnections()
})
</script>